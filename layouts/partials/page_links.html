{{/* -------------------------------------------------------------
  Initialize local variables
  $is_list: boolean indicating if this is a list view
  $page: current page object
  $link: temporary variable to store link URL
------------------------------------------------------------- */}}
{{ $is_list := .is_list }}
{{ $page := .page }}
{{ $link := "" }}

{{/* -------------------------------------------------------------
  TODO: Deprecate `url_preprint` in favor of `url_pdf` because
  there's now a dedicated "Preprint" publication type.
------------------------------------------------------------- */}}
{{ with $page.Params.url_preprint }}
  {{ $resource := $page.Resources.GetMatch . }}
  {{ if $resource }}
    {{ $link = $resource.RelPermalink }}
  {{ else }}
    {{ $link = . | relURL }}
  {{ end }}
  {{/* Render Preprint button */}}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link }}" target="_blank" rel="noopener">
    {{ i18n "btn_preprint" }}
  </a>
{{ end }}

{{/* -------------------------------------------------------------
  Determine PDF link for the publication
  Check if the page has a local PDF resource or url_pdf param
------------------------------------------------------------- */}}
{{ $pdf := "" }}
{{ $resource := $page.Resources.GetMatch (printf "%s.pdf" $page.File.ContentBaseName) }}
{{ with $resource }}
  {{ $pdf = .RelPermalink }}
{{ else }}
  {{ if $page.Params.url_pdf }}
    {{ $pdf = $page.Params.url_pdf | relURL }}
  {{ end }}
{{ end }}

{{/* Render PDF button if link exists */}}
{{ with $pdf }}
<a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ . }}" target="_blank" rel="noopener">
  <i class="fa fa-file-invoice"></i>
  {{ i18n "btn_pdf" }}
</a>
{{ end }}

{{/* -------------------------------------------------------------
  Render Cite button if cite.bib resource exists
------------------------------------------------------------- */}}
{{ $resource := $page.Resources.GetMatch "cite.bib" }}
{{ with $resource }}
<a href="#" class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}} js-cite-modal"
        data-filename="{{ .RelPermalink }}">
  <i class="fa fa-quote-right"></i>
  {{ i18n "btn_cite" }}
</a>
{{ end }}

{{/* -------------------------------------------------------------
  Render Code button if url_code param exists
------------------------------------------------------------- */}}
{{ with $page.Params.url_code }}
  {{ $resource := $page.Resources.GetMatch . }}
  {{ if $resource }}
    {{ $link = $resource.RelPermalink }}
  {{ else }}
    {{ $link = . | relURL }}
  {{ end }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link }}" target="_blank" rel="noopener">
    <i class="fa fa-code"></i>
    {{ i18n "btn_code" }}
  </a>
{{ end }}

{{/* -------------------------------------------------------------
  Render Dataset button if url_dataset param exists
------------------------------------------------------------- */}}
{{ with $page.Params.url_dataset }}
  {{ $resource := $page.Resources.GetMatch . }}
  {{ if $resource }}
    {{ $link = $resource.RelPermalink }}
  {{ else }}
    {{ $link = . | relURL }}
  {{ end }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link }}" target="_blank" rel="noopener">
    <i class="fa fa-database"></i>
    {{ i18n "btn_dataset" }}
  </a>
{{ end }}

{{/* -------------------------------------------------------------
  Render Project buttons
  - If multiple projects listed in front matter, render each
  - Fallback to single url_project param if no projects array
------------------------------------------------------------- */}}
{{ if $page.Params.projects }}
{{ range $page.Params.projects }}
  {{ with (site.GetPage (printf "project/%s" .)) }}
    <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ .RelPermalink }}">
      <i class="fa fa-sitemap"></i>
      {{ i18n "btn_project" }}
    </a>
  {{ else }}
    {{/* Optional: log an error if project reference is broken */}}
  {{ end }}
{{ end }}
{{ else }}
{{ with $page.Params.url_project }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ . }}" target="_blank" rel="noopener">
    <i class="fa fa-sitemap"></i>
    {{ i18n "btn_project" }}
  </a>
{{ end }}
{{ end }}

{{/* -------------------------------------------------------------
  Render Poster button if url_poster param exists
------------------------------------------------------------- */}}
{{ with $page.Params.url_poster }}
  {{ $resource := $page.Resources.GetMatch . }}
  {{ if $resource }}
    {{ $link = $resource.RelPermalink }}
  {{ else }}
    {{ $link = . | relURL }}
  {{ end }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link }}" target="_blank" rel="noopener">
    {{ i18n "btn_poster" }}
  </a>
{{ end }}

{{/* -------------------------------------------------------------
  Render Slides button
  - Prefer local slide page if available
  - Fallback to url_slides param
------------------------------------------------------------- */}}
{{ if $page.Params.slides }}
  {{ with (site.GetPage (printf "slides/%s" $page.Params.slides)) }}
    <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ .RelPermalink }}" target="_blank">
      <i class="fa fa-person-chalkboard"></i>
      {{ i18n "btn_slides" }}
    </a>
  {{ end }}
{{ else }}
  {{ with $page.Params.url_slides }}
    {{ $resource := $page.Resources.GetMatch . }}
    {{ if $resource }}
      {{ $link = $resource.RelPermalink }}
    {{ else }}
      {{ $link = . | relURL }}
    {{ end }}
    <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link }}" target="_blank" rel="noopener">
      <i class="fa fa-person-chalkboard"></i>
      {{ i18n "btn_slides" }}
    </a>
  {{ end }}
{{ end }}

{{/* -------------------------------------------------------------
  Render Video button if url_video param exists
------------------------------------------------------------- */}}
{{ with $page.Params.url_video }}
  {{ $resource := $page.Resources.GetMatch . }}
  {{ if $resource }}
    {{ $link = $resource.RelPermalink }}
  {{ else }}
    {{ $link = . | relURL }}
  {{ end }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link }}" target="_blank" rel="noopener">
    {{ i18n "btn_video" }}
  </a>
{{ end }}

{{/* -------------------------------------------------------------
  Render Source button if url_source param exists
------------------------------------------------------------- */}}
{{ with $page.Params.url_source }}
  {{ $resource := $page.Resources.GetMatch . }}
  {{ if $resource }}
    {{ $link = $resource.RelPermalink }}
  {{ else }}
    {{ $link = . | relURL }}
  {{ end }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link }}" target="_blank" rel="noopener">
    {{ i18n "btn_source" }}
  </a>
{{ end }}

{{/* -------------------------------------------------------------
  Render DOI button if DOI param exists
------------------------------------------------------------- */}}
{{ with $page.Params.doi }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="https://doi.org/{{ . }}" target="_blank" rel="noopener">
    <i class="ai ai-doi"></i>
    DOI
  </a>
{{ end }}

{{/* -------------------------------------------------------------
  Render additional custom links specified in front matter
  - Supports icon packs: fas, far, fal, fab
  - Opens external links in new tab
------------------------------------------------------------- */}}
{{ range $page.Params.links }}
  {{ $pack := or .icon_pack "fas" }}
  {{ $pack_prefix := $pack }}
  {{ if in (slice "fab" "fas" "far" "fal") $pack }}
    {{ $pack_prefix = "fa" }}
  {{ end }}
  {{ $link := .url | default "" }}
  {{ $scheme := (urls.Parse $link).Scheme }}
  {{ $target := "" }}
  {{ if not $scheme }}
    {{ $resource := $page.Resources.GetMatch $link }}
    {{ if $resource }}
      {{ $link = $resource.RelPermalink }}
    {{ else }}
      {{ $link = $link | relURL }}
    {{ end }}
  {{ else if in (slice "http" "https") $scheme }}
    {{ $target = "target=\"_blank\" rel=\"noopener\"" }}
  {{ end }}
  <a class="btn btn-outline-primary btn-page-header{{ if $is_list }} btn-sm{{end}}" href="{{ $link | safeURL }}" {{ $target | safeHTMLAttr }}>
    {{ if .icon }}<i class="{{ $pack }} {{ $pack_prefix }}-{{ .icon }} {{if .name}}mr-1{{end}}"></i>{{end}}
    {{- with .name }}{{ . | safeHTML }}{{ end -}}
  </a>
{{ end }}